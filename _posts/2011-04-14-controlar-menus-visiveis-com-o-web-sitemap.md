---
title: Controlar Menus visiveis com o web.sitemap
date: 2011-04-14T13:52:21+00:00
author: tiagosalgado
layout: post
categories:
  - c#
tags:
  - asp.net
  - 'C#'
---
Uma maneira rápida de ter um menu a funcionar no nosso website, é recorrer ao controlo Menu e associá-lo a um web.sitemap usando o SiteMapDataSource.

Exemplo do ficheiro web.sitemap:

<pre>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;siteMap xmlns="http://schemas.microsoft.com/AspNet/SiteMap-File-1.0" &gt;
    &lt;siteMapNode  url="~/" title="Home"  description="Home" &gt;
        &lt;siteMapNode url="" description="Menu 1" title="Menu 1"&gt;
            &lt;siteMapNode url="" description="SubMenu 1" title="Sub Menu 1"/&gt;
        &lt;/siteMapNode&gt;
        &lt;siteMapNode url="" description="Menu 2" title="Menu 2"/&gt;
        &lt;siteMapNode url="" description="Menu 3" title="Menu 3"/&gt;
    &lt;/siteMapNode&gt;
&lt;/siteMap&gt;</pre>

Exemplo do código para adicionar na página o menu:

<pre><pre>&lt;asp:Menu ID="NavigationMenu" runat="server" CssClass="menu" 
    EnableViewState="False" IncludeStyleBlock="False" Orientation="Horizontal" 
    DataSourceID="SiteMapDataSource1" onmenuitemdatabound="NavigationMenu_MenuItemDataBound"&gt;
&lt;/asp:Menu&gt;
&lt;asp:SiteMapDataSource ID="SiteMapDataSource1" runat="server"  ShowStartingNode="false" /&gt;</pre>


<p>
  Correndo a aplicação, iremos ter algo como a próxima imagem:
</p>


<p>
  <img src="http://img576.imageshack.us/img576/1593/menu1rc.png" alt="" width="454" height="143" />
</p>


<p>
  Para mostrar ou esconder os menus, consoante o tipo de acesso de cada utilizador, podemos definir as Roles em cada SiteMapNode.
</p>


<p>
  Outra forma de controlar os menus visiveis, é adicionar um atributo em cada SiteMapNode e consoante o seu valor, irá ou não mostrar cada um dos menus.
</p>


<p>
  Para isso, o web.sitemap será algo como:
</p>


<pre>


<pre>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;siteMap xmlns="http://schemas.microsoft.com/AspNet/SiteMap-File-1.0"&gt;
  &lt;siteMapNode url="~/" title="Home" description="Home" visible="true"&gt;
    &lt;siteMapNode url="" description="Menu 1" title="Menu 1" visible="true"&gt;
      &lt;siteMapNode url="" description="SubMenu 1" title="Sub Menu 1" visible="true" /&gt;
    &lt;/siteMapNode&gt;
    &lt;siteMapNode url="" description="Menu 2" title="Menu 2" visible="False" /&gt;
    &lt;siteMapNode url="" description="Menu 3" title="Menu 3" visible="true" /&gt;
  &lt;/siteMapNode&gt;
&lt;/siteMap&gt;</pre>


<p>
  O atributo “visible” é que nos vai indicar se o menu é ou não mostrado, e para isso vamos adicionar ao evento MenuItemDataBound do Menu o seguinte código:
</p>


<pre>


<pre>protected void NavigationMenu_MenuItemDataBound(object sender, MenuEventArgs e)
{
    SiteMapNode node = e.Item.DataItem as SiteMapNode;
    if (!string.IsNullOrEmpty(node["visible"]))
    {
        bool isVisible;
        if (bool.TryParse(node["visible"], out isVisible))
        {
            if (!isVisible)
            {
                if (e.Item.Parent != null)
                    e.Item.Parent.ChildItems.Remove(e.Item);
                else
                    ((Menu)sender).Items.Remove(e.Item);
            }
        }
    }
}</pre>


<p>
  Desta forma, teremos o nosso menu a mostrar todos os nós cujo valor do atributo Visible seja igual a True.
</p>


<p>
  Para podermos controlar directamente os menus que irão estar ou não visiveis, utilizei uma Treeview para carregar o ficheiro web.sitemap, definir que todos os items mostrarão uma checkbox, que irá indicar o estado do atributo Visible.
</p>


<pre>


<pre>&lt;asp:TreeView runat="server" ID="tvMenus" AutoGenerateDataBindings="False" DataSourceID="XmlDsSiteMap"
    OnTreeNodeCheckChanged="tvMenus_TreeNodeCheckChanged" ShowCheckBoxes="All" ShowLines="True"
    OnTreeNodeDataBound="tvMenus_TreeNodeDataBound"&gt;
    &lt;DataBindings&gt;
        &lt;asp:TreeNodeBinding DataMember="siteMapNode" SelectAction="None" ShowCheckBox="True"
            TextField="title" /&gt;
        &lt;asp:TreeNodeBinding DataMember="siteMapNode" TextField="title" /&gt;
        &lt;asp:TreeNodeBinding DataMember="siteMapNode" TextField="title" /&gt;
        &lt;asp:TreeNodeBinding DataMember="siteMap" /&gt;
    &lt;/DataBindings&gt;
&lt;/asp:TreeView&gt;
&lt;asp:XmlDataSource ID="XmlDsSiteMap" runat="server" DataFile="~/Web.sitemap" XPath="/*/*/*"&gt;
&lt;/asp:XmlDataSource&gt;
    &lt;p&gt;
        &lt;asp:Button runat="server" ID="btn" Text="gravar" OnClick="btn_Click" /&gt;&lt;/p&gt;</pre>


<p>
  &nbsp;
</p>


<pre>


<pre>protected void tvMenus_TreeNodeDataBound(object sender, TreeNodeEventArgs e)
{
    XmlElement node = e.Node.DataItem as XmlElement;
    if (node.Attributes["visible"] != null)
    {
        if (!string.IsNullOrEmpty(node.Attributes["visible"].Value))
        {
            bool isVisible;
            if (bool.TryParse(node.Attributes["visible"].Value, out isVisible))
            {
                e.Node.Checked = isVisible;
            }
            else
                e.Node.Checked = true;
        }
        else
            e.Node.Checked = true;
    }
}</pre>


<p>
  <img src="http://img828.imageshack.us/img828/8241/menu2f.png" alt="" width="396" height="276" />
</p>


<p>
  Por fim, para gravarmos as alterações do atributo consoante o estado da checkbox, adicionamos ao evento TreeNodeCheckChanged da Treeview o seguinte código:
</p>


<pre>


<pre>protected void tvMenus_TreeNodeCheckChanged(object sender, TreeNodeEventArgs e)
{
    XmlDsSiteMap.GetXmlDocument().SelectSingleNode(e.Node.DataPath).Attributes["visible"].Value = e.Node.Checked.ToString();
}</pre>


<p>
  E ao botão que adicionamos para gravar as alterações o seguinte código:
</p>


<pre>


<pre>protected void btn_Click(object sender, EventArgs e)
{
    XmlDsSiteMap.Save();
}</pre>


<p>
  Agora é só activar e desactivar os items ao nosso gosto.
</p>


<p>
  <img src="http://img828.imageshack.us/img828/543/menu3x.png" alt="" width="356" height="271" />
</p>